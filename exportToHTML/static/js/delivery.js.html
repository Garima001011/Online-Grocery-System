<html>
<head>
<title>delivery.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #6aab73;}
.s2 { color: #cf8e6d;}
.s3 { color: #2aacb8;}
.s4 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
delivery.js</font>
</center></td></tr></table>
<pre><span class="s0">const user = JSON.parse(localStorage.getItem(</span><span class="s1">&quot;user&quot;</span><span class="s0">) || </span><span class="s1">&quot;null&quot;</span><span class="s0">);</span>
<span class="s2">if </span><span class="s0">(!user || user.role !== </span><span class="s1">&quot;DELIVERY&quot;</span><span class="s0">) window.location.href = </span><span class="s1">&quot;/login.html&quot;</span><span class="s0">;</span>

<span class="s0">document.getElementById(</span><span class="s1">&quot;who&quot;</span><span class="s0">).innerText = `${user.email} ‚Ä¢ ${user.role}`;</span>

<span class="s0">let currentOrders = [];</span>
<span class="s0">let selectedOrderId = </span><span class="s2">null</span><span class="s0">;</span>

<span class="s0">init();</span>

<span class="s0">async </span><span class="s2">function </span><span class="s0">init() {</span>
  <span class="s0">await loadMyOrders();</span>
<span class="s0">}</span>

<span class="s0">async </span><span class="s2">function </span><span class="s0">loadMyOrders() {</span>
  <span class="s2">try </span><span class="s0">{</span>
    <span class="s0">const response = await fetch(`/api/delivery/my-orders?deliveryPersonId=${user.id}`);</span>
    <span class="s2">if </span><span class="s0">(!response.ok) </span><span class="s2">throw new </span><span class="s0">Error(</span><span class="s1">&quot;Failed to load orders&quot;</span><span class="s0">);</span>

    <span class="s0">currentOrders = await response.json();</span>
    <span class="s0">renderOrderList();</span>
  <span class="s0">} </span><span class="s2">catch </span><span class="s0">(error) {</span>
    <span class="s0">console.error(</span><span class="s1">&quot;Error loading orders:&quot;</span><span class="s0">, error);</span>
    <span class="s0">alert(</span><span class="s1">&quot;Failed to load your orders. Please refresh.&quot;</span><span class="s0">);</span>
  <span class="s0">}</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">renderOrderList() {</span>
  <span class="s0">const list = document.getElementById(</span><span class="s1">&quot;orderList&quot;</span><span class="s0">);</span>
  <span class="s0">list.innerHTML = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(currentOrders.length === </span><span class="s3">0</span><span class="s0">) {</span>
    <span class="s0">list.innerHTML = </span><span class="s1">'&lt;div class=&quot;item&quot; style=&quot;text-align: center; padding: 20px; color: var(--muted);&quot;&gt;No orders assigned to you yet.&lt;/div&gt;'</span><span class="s0">;</span>
    <span class="s2">return</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s0">currentOrders.forEach(order =&gt; {</span>
    <span class="s0">const orderDate = </span><span class="s2">new </span><span class="s0">Date(order.createdAt).toLocaleDateString();</span>
    <span class="s0">const itemCount = order.orderItems ? order.orderItems.length : </span><span class="s3">0</span><span class="s0">;</span>

    <span class="s0">const el = document.createElement(</span><span class="s1">&quot;div&quot;</span><span class="s0">);</span>
    <span class="s0">el.className = </span><span class="s1">&quot;item&quot;</span><span class="s0">;</span>
    <span class="s0">el.style.cursor = </span><span class="s1">&quot;pointer&quot;</span><span class="s0">;</span>
    <span class="s0">el.style.borderLeft = `</span><span class="s3">4</span><span class="s0">px solid ${getStatusColor(order.status)}`;</span>
    <span class="s0">el.onclick = () =&gt; selectOrder(order.id);</span>

    <span class="s2">if </span><span class="s0">(selectedOrderId === order.id) {</span>
      <span class="s0">el.style.background = </span><span class="s1">&quot;rgba(255,255,255,0.08)&quot;</span><span class="s0">;</span>
      <span class="s0">el.style.borderColor = </span><span class="s1">&quot;var(--p2)&quot;</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s0">el.innerHTML = `</span>
      <span class="s0">&lt;div style=</span><span class="s1">&quot;flex: 1;&quot;</span><span class="s0">&gt;</span>
        <span class="s0">&lt;strong&gt;Order #${order.id}&lt;/strong&gt;</span>
        <span class="s0">&lt;div class=</span><span class="s1">&quot;meta&quot;</span><span class="s0">&gt;${orderDate} ‚Ä¢ ${itemCount} items ‚Ä¢ Rs. ${formatNpr(order.total || </span><span class="s3">0</span><span class="s0">)}&lt;/div&gt;</span>
        <span class="s0">&lt;div class=</span><span class="s1">&quot;meta&quot;</span><span class="s0">&gt;</span>
          <span class="s0">&lt;span class=</span><span class="s1">&quot;status-badge status-${order.status.toLowerCase()}&quot;</span><span class="s0">&gt;${order.status}&lt;/span&gt;</span>
          <span class="s0">${order.deliveryNotes ? </span><span class="s1">'üìù' </span><span class="s0">: </span><span class="s1">''</span><span class="s0">}</span>
        <span class="s0">&lt;/div&gt;</span>
      <span class="s0">&lt;/div&gt;</span>
      <span class="s0">&lt;div class=</span><span class="s1">&quot;actions&quot;</span><span class="s0">&gt;</span>
        <span class="s0">&lt;span class=</span><span class="s1">&quot;badge&quot;</span><span class="s0">&gt;${order.user ? order.user.email : </span><span class="s1">'‚Äî'</span><span class="s0">}&lt;/span&gt;</span>
      <span class="s0">&lt;/div&gt;</span>
    <span class="s0">`;</span>

    <span class="s0">list.appendChild(el);</span>
  <span class="s0">});</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">getStatusColor(status) {</span>
  <span class="s2">switch</span><span class="s0">(status.toLowerCase()) {</span>
    <span class="s2">case </span><span class="s1">'placed'</span><span class="s0">: </span><span class="s2">return </span><span class="s1">'#60a5fa'</span><span class="s0">;</span>
    <span class="s2">case </span><span class="s1">'assigned'</span><span class="s0">: </span><span class="s2">return </span><span class="s1">'#f59e0b'</span><span class="s0">;</span>
    <span class="s2">case </span><span class="s1">'picked_up'</span><span class="s0">: </span><span class="s2">return </span><span class="s1">'#8b5cf6'</span><span class="s0">;</span>
    <span class="s2">case </span><span class="s1">'delivered'</span><span class="s0">: </span><span class="s2">return </span><span class="s1">'#10b981'</span><span class="s0">;</span>
    <span class="s2">case </span><span class="s1">'cancelled'</span><span class="s0">: </span><span class="s2">return </span><span class="s1">'#ef4444'</span><span class="s0">;</span>
    <span class="s2">default</span><span class="s0">: </span><span class="s2">return </span><span class="s1">'var(--muted)'</span><span class="s0">;</span>
  <span class="s0">}</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">selectOrder(orderId) {</span>
  <span class="s0">selectedOrderId = orderId;</span>
  <span class="s0">renderOrderList();</span>
  <span class="s0">showOrderDetails(orderId);</span>
<span class="s0">}</span>

<span class="s0">async </span><span class="s2">function </span><span class="s0">showOrderDetails(orderId) {</span>
  <span class="s0">const order = currentOrders.find(o =&gt; o.id === orderId);</span>
  <span class="s2">if </span><span class="s0">(!order) </span><span class="s2">return</span><span class="s0">;</span>

  <span class="s0">document.getElementById(</span><span class="s1">&quot;noOrderSelected&quot;</span><span class="s0">).style.display = </span><span class="s1">&quot;none&quot;</span><span class="s0">;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;orderDetails&quot;</span><span class="s0">).style.display = </span><span class="s1">&quot;block&quot;</span><span class="s0">;</span>

  <span class="s4">// Update basic info</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;orderId&quot;</span><span class="s0">).innerText = `#${order.id}`;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;orderTotal&quot;</span><span class="s0">).innerText = `Rs. ${formatNpr(order.total || </span><span class="s3">0</span><span class="s0">)}`;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;orderStatus&quot;</span><span class="s0">).innerText = order.status;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;orderStatus&quot;</span><span class="s0">).style.color = getStatusColor(order.status);</span>

  <span class="s4">// Render timeline</span>
  <span class="s0">renderTimeline(order);</span>

  <span class="s4">// Customer info</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;customerEmail&quot;</span><span class="s0">).innerText = order.user ? order.user.email : </span><span class="s1">'Unknown'</span><span class="s0">;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;customerId&quot;</span><span class="s0">).innerText = `Customer ID: ${order.user ? order.user.id : </span><span class="s1">'‚Äî'</span><span class="s0">}`;</span>

  <span class="s4">// Address</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;deliveryAddress&quot;</span><span class="s0">).innerText = order.deliveryAddress || </span><span class="s1">'‚Äî'</span><span class="s0">;</span>

  <span class="s4">// Items</span>
  <span class="s0">const itemsList = document.getElementById(</span><span class="s1">&quot;orderItems&quot;</span><span class="s0">);</span>
  <span class="s0">itemsList.innerHTML = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(order.orderItems &amp;&amp; order.orderItems.length &gt; </span><span class="s3">0</span><span class="s0">) {</span>
    <span class="s0">order.orderItems.forEach(item =&gt; {</span>
      <span class="s0">const li = document.createElement(</span><span class="s1">&quot;div&quot;</span><span class="s0">);</span>
      <span class="s0">li.className = </span><span class="s1">&quot;item&quot;</span><span class="s0">;</span>
      <span class="s0">li.style.padding = </span><span class="s1">&quot;8px 12px&quot;</span><span class="s0">;</span>
      <span class="s0">li.innerHTML = `</span>
        <span class="s0">&lt;div&gt;</span>
          <span class="s0">&lt;strong&gt;${item.product ? item.product.name : </span><span class="s1">'Unknown'</span><span class="s0">}&lt;/strong&gt;</span>
          <span class="s0">&lt;div class=</span><span class="s1">&quot;meta&quot;</span><span class="s0">&gt;${item.quantity} √ó Rs. ${formatNpr(item.priceAtPurchase)} = Rs. ${formatNpr(item.quantity * item.priceAtPurchase)}&lt;/div&gt;</span>
        <span class="s0">&lt;/div&gt;</span>
      <span class="s0">`;</span>
      <span class="s0">itemsList.appendChild(li);</span>
    <span class="s0">});</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s0">itemsList.innerHTML = </span><span class="s1">'&lt;div class=&quot;muted&quot; style=&quot;text-align: center; padding: 20px;&quot;&gt;No items found&lt;/div&gt;'</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s4">// Update action buttons based on status</span>
  <span class="s0">const btnPickup = document.getElementById(</span><span class="s1">&quot;btnPickup&quot;</span><span class="s0">);</span>
  <span class="s0">const btnDeliver = document.getElementById(</span><span class="s1">&quot;btnDeliver&quot;</span><span class="s0">);</span>
  <span class="s0">const btnCancel = document.getElementById(</span><span class="s1">&quot;btnCancel&quot;</span><span class="s0">);</span>

  <span class="s0">btnPickup.disabled = order.status !== </span><span class="s1">'ASSIGNED'</span><span class="s0">;</span>
  <span class="s0">btnDeliver.disabled = order.status !== </span><span class="s1">'PICKED_UP'</span><span class="s0">;</span>
  <span class="s0">btnCancel.disabled = order.status === </span><span class="s1">'CANCELLED' </span><span class="s0">|| order.status === </span><span class="s1">'DELIVERED'</span><span class="s0">;</span>

  <span class="s4">// Notes</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;deliveryNotes&quot;</span><span class="s0">).value = order.deliveryNotes || </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>

  <span class="s4">// Update selected order info</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;selectedOrderInfo&quot;</span><span class="s0">).innerText =</span>
    <span class="s0">`Order #${order.id} ‚Ä¢ ${</span><span class="s2">new </span><span class="s0">Date(order.createdAt).toLocaleDateString()} ‚Ä¢ ${order.status}`;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">renderTimeline(order) {</span>
  <span class="s0">const timeline = document.getElementById(</span><span class="s1">&quot;orderTimeline&quot;</span><span class="s0">);</span>
  <span class="s0">const steps = [</span>
    <span class="s0">{ key: </span><span class="s1">'PLACED'</span><span class="s0">, label: </span><span class="s1">'Placed'</span><span class="s0">, time: order.createdAt },</span>
    <span class="s0">{ key: </span><span class="s1">'ASSIGNED'</span><span class="s0">, label: </span><span class="s1">'Assigned'</span><span class="s0">, time: order.assignedAt },</span>
    <span class="s0">{ key: </span><span class="s1">'PICKED_UP'</span><span class="s0">, label: </span><span class="s1">'Picked Up'</span><span class="s0">, time: order.pickedUpAt },</span>
    <span class="s0">{ key: </span><span class="s1">'DELIVERED'</span><span class="s0">, label: </span><span class="s1">'Delivered'</span><span class="s0">, time: order.deliveredAt }</span>
  <span class="s0">];</span>

  <span class="s0">let html = </span><span class="s1">''</span><span class="s0">;</span>
  <span class="s0">const statusOrder = [</span><span class="s1">'PLACED'</span><span class="s0">, </span><span class="s1">'ASSIGNED'</span><span class="s0">, </span><span class="s1">'PICKED_UP'</span><span class="s0">, </span><span class="s1">'DELIVERED'</span><span class="s0">];</span>
  <span class="s0">const currentIndex = statusOrder.indexOf(order.status);</span>

  <span class="s0">steps.forEach((step, index) =&gt; {</span>
    <span class="s0">let className = </span><span class="s1">''</span><span class="s0">;</span>
    <span class="s2">if </span><span class="s0">(step.time) {</span>
      <span class="s0">className = </span><span class="s1">'completed'</span><span class="s0">;</span>
    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(index === currentIndex) {</span>
      <span class="s0">className = </span><span class="s1">'active'</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s0">const timeStr = step.time ? </span><span class="s2">new </span><span class="s0">Date(step.time).toLocaleTimeString([], {hour: </span><span class="s1">'2-digit'</span><span class="s0">, minute:</span><span class="s1">'2-digit'</span><span class="s0">}) : </span><span class="s1">''</span><span class="s0">;</span>

    <span class="s0">html += `</span>
      <span class="s0">&lt;div class=</span><span class="s1">&quot;timeline-step ${className}&quot;</span><span class="s0">&gt;</span>
        <span class="s0">&lt;div class=</span><span class="s1">&quot;dot&quot;</span><span class="s0">&gt;&lt;/div&gt;</span>
        <span class="s0">&lt;div class=</span><span class="s1">&quot;timeline-label&quot;</span><span class="s0">&gt;${step.label}&lt;/div&gt;</span>
        <span class="s0">&lt;div class=</span><span class="s1">&quot;timeline-label&quot; </span><span class="s0">style=</span><span class="s1">&quot;font-size: 10px;&quot;</span><span class="s0">&gt;${timeStr}&lt;/div&gt;</span>
      <span class="s0">&lt;/div&gt;</span>
    <span class="s0">`;</span>
  <span class="s0">});</span>

  <span class="s0">timeline.innerHTML = html;</span>
<span class="s0">}</span>

<span class="s0">async </span><span class="s2">function </span><span class="s0">updateStatus(newStatus) {</span>
  <span class="s2">if </span><span class="s0">(!selectedOrderId) </span><span class="s2">return </span><span class="s0">alert(</span><span class="s1">&quot;Select an order first.&quot;</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(!confirm(`Are you sure you want to mark </span><span class="s2">this </span><span class="s0">order as ${newStatus}?`)) </span><span class="s2">return</span><span class="s0">;</span>

  <span class="s2">try </span><span class="s0">{</span>
    <span class="s0">const response = await fetch(</span><span class="s1">'/api/delivery/update-status'</span><span class="s0">, {</span>
      <span class="s0">method: </span><span class="s1">'POST'</span><span class="s0">,</span>
      <span class="s0">headers: { </span><span class="s1">'Content-Type'</span><span class="s0">: </span><span class="s1">'application/json' </span><span class="s0">},</span>
      <span class="s0">body: JSON.stringify({</span>
        <span class="s0">orderId: selectedOrderId,</span>
        <span class="s0">deliveryPersonId: user.id,</span>
        <span class="s0">status: newStatus</span>
      <span class="s0">})</span>
    <span class="s0">});</span>

    <span class="s2">if </span><span class="s0">(!response.ok) {</span>
      <span class="s0">const error = await response.text();</span>
      <span class="s2">throw new </span><span class="s0">Error(error);</span>
    <span class="s0">}</span>

    <span class="s0">const updatedOrder = await response.json();</span>

    <span class="s4">// Update local order</span>
    <span class="s0">const index = currentOrders.findIndex(o =&gt; o.id === selectedOrderId);</span>
    <span class="s2">if </span><span class="s0">(index !== -</span><span class="s3">1</span><span class="s0">) {</span>
      <span class="s0">currentOrders[index] = updatedOrder;</span>
    <span class="s0">}</span>

    <span class="s4">// Refresh UI</span>
    <span class="s0">renderOrderList();</span>
    <span class="s0">showOrderDetails(selectedOrderId);</span>

    <span class="s0">alert(`Order status updated to ${newStatus}`);</span>
  <span class="s0">} </span><span class="s2">catch </span><span class="s0">(error) {</span>
    <span class="s0">console.error(</span><span class="s1">&quot;Error updating status:&quot;</span><span class="s0">, error);</span>
    <span class="s0">alert(</span><span class="s1">&quot;Failed to update order status: &quot; </span><span class="s0">+ error.message);</span>
  <span class="s0">}</span>
<span class="s0">}</span>

<span class="s0">async </span><span class="s2">function </span><span class="s0">saveNotes() {</span>
  <span class="s2">if </span><span class="s0">(!selectedOrderId) </span><span class="s2">return </span><span class="s0">alert(</span><span class="s1">&quot;Select an order first.&quot;</span><span class="s0">);</span>

  <span class="s0">const notes = document.getElementById(</span><span class="s1">&quot;deliveryNotes&quot;</span><span class="s0">).value.trim();</span>

  <span class="s2">try </span><span class="s0">{</span>
    <span class="s0">const response = await fetch(`/api/orders/${selectedOrderId}/notes`, {</span>
      <span class="s0">method: </span><span class="s1">'POST'</span><span class="s0">,</span>
      <span class="s0">headers: { </span><span class="s1">'Content-Type'</span><span class="s0">: </span><span class="s1">'application/json' </span><span class="s0">},</span>
      <span class="s0">body: JSON.stringify({ notes })</span>
    <span class="s0">});</span>

    <span class="s2">if </span><span class="s0">(!response.ok) </span><span class="s2">throw new </span><span class="s0">Error(</span><span class="s1">&quot;Failed to save notes&quot;</span><span class="s0">);</span>

    <span class="s4">// Update local order</span>
    <span class="s0">const index = currentOrders.findIndex(o =&gt; o.id === selectedOrderId);</span>
    <span class="s2">if </span><span class="s0">(index !== -</span><span class="s3">1</span><span class="s0">) {</span>
      <span class="s0">currentOrders[index].deliveryNotes = notes;</span>
    <span class="s0">}</span>

    <span class="s0">alert(</span><span class="s1">&quot;Notes saved successfully&quot;</span><span class="s0">);</span>
  <span class="s0">} </span><span class="s2">catch </span><span class="s0">(error) {</span>
    <span class="s0">console.error(</span><span class="s1">&quot;Error saving notes:&quot;</span><span class="s0">, error);</span>
    <span class="s0">alert(</span><span class="s1">&quot;Failed to save notes.&quot;</span><span class="s0">);</span>
  <span class="s0">}</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">refreshOrders() {</span>
  <span class="s0">loadMyOrders();</span>
  <span class="s2">if </span><span class="s0">(selectedOrderId) {</span>
    <span class="s0">const order = currentOrders.find(o =&gt; o.id === selectedOrderId);</span>
    <span class="s2">if </span><span class="s0">(order) showOrderDetails(selectedOrderId);</span>
  <span class="s0">}</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">logout() {</span>
  <span class="s0">localStorage.removeItem(</span><span class="s1">&quot;user&quot;</span><span class="s0">);</span>
  <span class="s0">window.location.href = </span><span class="s1">&quot;/login.html&quot;</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">formatNpr(n) {</span>
  <span class="s2">return new </span><span class="s0">Intl.NumberFormat(</span><span class="s1">&quot;en-NP&quot;</span><span class="s0">, { maximumFractionDigits: </span><span class="s3">2 </span><span class="s0">}).format(n);</span>
<span class="s0">}</span></pre>
</body>
</html>