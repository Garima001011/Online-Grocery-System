<html>
<head>
<title>shop.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #6aab73;}
.s2 { color: #cf8e6d;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
shop.js</font>
</center></td></tr></table>
<pre><span class="s0">const user = JSON.parse(localStorage.getItem(</span><span class="s1">&quot;user&quot;</span><span class="s0">) || </span><span class="s1">&quot;null&quot;</span><span class="s0">);</span>
<span class="s2">if </span><span class="s0">(!user) window.location.href = </span><span class="s1">&quot;/login.html&quot;</span><span class="s0">;</span>

<span class="s0">document.getElementById(</span><span class="s1">&quot;who&quot;</span><span class="s0">).innerText = `${user.email} • ${user.role}`;</span>

<span class="s0">let cart = JSON.parse(localStorage.getItem(</span><span class="s1">&quot;cart&quot;</span><span class="s0">) || </span><span class="s1">&quot;[]&quot;</span><span class="s0">);</span>

<span class="s0">let stores = [];</span>
<span class="s0">let categories = [];</span>
<span class="s0">let currentStoreId = </span><span class="s2">null</span><span class="s0">;</span>
<span class="s0">let currentCategoryId = </span><span class="s2">null</span><span class="s0">;</span>
<span class="s0">let currentQ = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>

<span class="s3">// Tax and promo variables</span>
<span class="s0">const TAX_RATE = </span><span class="s4">0.13</span><span class="s0">;</span>
<span class="s0">let promoDiscountRate = </span><span class="s4">0</span><span class="s0">; </span><span class="s3">// e.g., 0.10 for 10%</span>

<span class="s0">init();</span>

<span class="s0">async </span><span class="s2">function </span><span class="s0">init() {</span>
  <span class="s0">await Promise.all([loadStores(), loadCategories()]);</span>
  <span class="s0">hydrateFilters();</span>
  <span class="s0">await loadProducts();</span>
  <span class="s0">renderCart();</span>
<span class="s0">}</span>

<span class="s0">async </span><span class="s2">function </span><span class="s0">loadStores() {</span>
  <span class="s0">const r = await fetch(</span><span class="s1">&quot;/api/stores&quot;</span><span class="s0">);</span>
  <span class="s0">stores = await r.json();</span>
<span class="s0">}</span>

<span class="s0">async </span><span class="s2">function </span><span class="s0">loadCategories() {</span>
  <span class="s0">const r = await fetch(</span><span class="s1">&quot;/api/categories&quot;</span><span class="s0">);</span>
  <span class="s0">categories = await r.json();</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">hydrateFilters() {</span>
  <span class="s0">const storeSel = document.getElementById(</span><span class="s1">&quot;storeSelect&quot;</span><span class="s0">);</span>
  <span class="s0">storeSel.innerHTML = `&lt;option value=</span><span class="s1">&quot;&quot;</span><span class="s0">&gt;All Stores&lt;/option&gt;` +</span>
    <span class="s0">stores.map(s =&gt; `&lt;option value=</span><span class="s1">&quot;${s.id}&quot;</span><span class="s0">&gt;${s.name}&lt;/option&gt;`).join(</span><span class="s1">&quot;&quot;</span><span class="s0">);</span>

  <span class="s0">const catSel = document.getElementById(</span><span class="s1">&quot;categorySelect&quot;</span><span class="s0">);</span>
  <span class="s0">catSel.innerHTML = `&lt;option value=</span><span class="s1">&quot;&quot;</span><span class="s0">&gt;All Categories&lt;/option&gt;` +</span>
    <span class="s0">categories.map(c =&gt; `&lt;option value=</span><span class="s1">&quot;${c.id}&quot;</span><span class="s0">&gt;${c.name}&lt;/option&gt;`).join(</span><span class="s1">&quot;&quot;</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">applyFilters() {</span>
  <span class="s0">currentQ = document.getElementById(</span><span class="s1">&quot;q&quot;</span><span class="s0">).value.trim();</span>
  <span class="s0">currentStoreId = document.getElementById(</span><span class="s1">&quot;storeSelect&quot;</span><span class="s0">).value || </span><span class="s2">null</span><span class="s0">;</span>
  <span class="s0">currentCategoryId = document.getElementById(</span><span class="s1">&quot;categorySelect&quot;</span><span class="s0">).value || </span><span class="s2">null</span><span class="s0">;</span>
  <span class="s0">loadProducts();</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">resetFilters() {</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;q&quot;</span><span class="s0">).value = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;storeSelect&quot;</span><span class="s0">).value = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;categorySelect&quot;</span><span class="s0">).value = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>
  <span class="s0">currentQ = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>
  <span class="s0">currentStoreId = </span><span class="s2">null</span><span class="s0">;</span>
  <span class="s0">currentCategoryId = </span><span class="s2">null</span><span class="s0">;</span>
  <span class="s0">loadProducts();</span>
<span class="s0">}</span>

<span class="s0">async </span><span class="s2">function </span><span class="s0">loadProducts() {</span>
  <span class="s0">const params = </span><span class="s2">new </span><span class="s0">URLSearchParams();</span>
  <span class="s2">if </span><span class="s0">(currentQ) params.set(</span><span class="s1">&quot;q&quot;</span><span class="s0">, currentQ);</span>
  <span class="s2">if </span><span class="s0">(currentStoreId) params.set(</span><span class="s1">&quot;storeId&quot;</span><span class="s0">, currentStoreId);</span>
  <span class="s2">if </span><span class="s0">(currentCategoryId) params.set(</span><span class="s1">&quot;categoryId&quot;</span><span class="s0">, currentCategoryId);</span>

  <span class="s0">const r = await fetch(</span><span class="s1">&quot;/api/products&quot; </span><span class="s0">+ (params.toString() ? `?${params}` : </span><span class="s1">&quot;&quot;</span><span class="s0">));</span>
  <span class="s0">const products = await r.json();</span>

  <span class="s0">const list = document.getElementById(</span><span class="s1">&quot;productList&quot;</span><span class="s0">);</span>
  <span class="s0">list.innerHTML = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>

  <span class="s0">products.forEach(p =&gt; {</span>
    <span class="s0">const li = document.createElement(</span><span class="s1">&quot;div&quot;</span><span class="s0">);</span>
    <span class="s0">li.className = </span><span class="s1">&quot;item&quot;</span><span class="s0">;</span>

    <span class="s0">const storeName = p.store ? p.store.name : </span><span class="s1">&quot;—&quot;</span><span class="s0">;</span>
    <span class="s0">const catName = p.category ? p.category.name : </span><span class="s1">&quot;—&quot;</span><span class="s0">;</span>

    <span class="s0">li.innerHTML = `</span>
      <span class="s0">&lt;div&gt;</span>
        <span class="s0">&lt;strong&gt;${p.name}&lt;/strong&gt;</span>
        <span class="s0">&lt;div class=</span><span class="s1">&quot;meta&quot;</span><span class="s0">&gt;${catName} • ${storeName} • Stock: ${p.stock}&lt;/div&gt;</span>
        <span class="s0">&lt;div class=</span><span class="s1">&quot;meta&quot;</span><span class="s0">&gt;Price: Rs. ${formatNpr(p.price)}&lt;/div&gt;</span>
      <span class="s0">&lt;/div&gt;</span>
      <span class="s0">&lt;div class=</span><span class="s1">&quot;actions&quot;</span><span class="s0">&gt;</span>
        <span class="s0">&lt;button ${p.stock &lt;= </span><span class="s4">0 </span><span class="s0">? </span><span class="s1">&quot;disabled&quot; </span><span class="s0">: </span><span class="s1">&quot;&quot;</span><span class="s0">} onclick=</span><span class="s1">&quot;addToCart(${p.id}, '${escapeQuotes(p.name)}', ${p.price}, ${p.stock}, ${p.store ? p.store.id : &quot;</span><span class="s2">null</span><span class="s1">&quot;})&quot;</span><span class="s0">&gt;</span>
          <span class="s0">Add</span>
        <span class="s0">&lt;/button&gt;</span>
      <span class="s0">&lt;/div&gt;</span>
    <span class="s0">`;</span>
    <span class="s0">list.appendChild(li);</span>
  <span class="s0">});</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">addToCart(productId, name, price, stock, storeId) {</span>
  <span class="s3">// Standard rule: cart should be from one store at a time (realistic local delivery)</span>
  <span class="s0">const cartStoreId = getCartStoreId();</span>
  <span class="s2">if </span><span class="s0">(cartStoreId &amp;&amp; storeId &amp;&amp; cartStoreId !== storeId) {</span>
    <span class="s0">alert(</span><span class="s1">&quot;Cart contains items from another store. Clear cart to switch stores.&quot;</span><span class="s0">);</span>
    <span class="s2">return</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s0">const item = cart.find(i =&gt; i.productId === productId);</span>
  <span class="s2">if </span><span class="s0">(item) {</span>
    <span class="s2">if </span><span class="s0">(item.quantity + </span><span class="s4">1 </span><span class="s0">&gt; stock) {</span>
      <span class="s0">alert(</span><span class="s1">&quot;Not enough stock.&quot;</span><span class="s0">);</span>
      <span class="s2">return</span><span class="s0">;</span>
    <span class="s0">}</span>
    <span class="s0">item.quantity++;</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s0">cart.push({ productId, name, price, quantity: </span><span class="s4">1</span><span class="s0">, storeId });</span>
  <span class="s0">}</span>
  <span class="s0">saveCart();</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">decQty(productId) {</span>
  <span class="s0">const item = cart.find(i =&gt; i.productId === productId);</span>
  <span class="s2">if </span><span class="s0">(!item) </span><span class="s2">return</span><span class="s0">;</span>
  <span class="s0">item.quantity--;</span>
  <span class="s2">if </span><span class="s0">(item.quantity &lt;= </span><span class="s4">0</span><span class="s0">) cart = cart.filter(i =&gt; i.productId !== productId);</span>
  <span class="s0">saveCart();</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">incQty(productId) {</span>
  <span class="s0">const item = cart.find(i =&gt; i.productId === productId);</span>
  <span class="s2">if </span><span class="s0">(!item) </span><span class="s2">return</span><span class="s0">;</span>
  <span class="s0">item.quantity++;</span>
  <span class="s0">saveCart();</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">removeFromCart(productId) {</span>
  <span class="s0">cart = cart.filter(i =&gt; i.productId !== productId);</span>
  <span class="s0">saveCart();</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">clearCart() {</span>
  <span class="s0">cart = [];</span>
  <span class="s0">saveCart();</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">saveCart() {</span>
  <span class="s0">localStorage.setItem(</span><span class="s1">&quot;cart&quot;</span><span class="s0">, JSON.stringify(cart));</span>
  <span class="s0">renderCart();</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">renderCart() {</span>
  <span class="s0">const list = document.getElementById(</span><span class="s1">&quot;cartList&quot;</span><span class="s0">);</span>

  <span class="s0">list.innerHTML = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>
  <span class="s0">let count = </span><span class="s4">0</span><span class="s0">;</span>

  <span class="s0">cart.forEach(i =&gt; {</span>
    <span class="s0">count += i.quantity;</span>

    <span class="s0">const li = document.createElement(</span><span class="s1">&quot;div&quot;</span><span class="s0">);</span>
    <span class="s0">li.className = </span><span class="s1">&quot;item&quot;</span><span class="s0">;</span>
    <span class="s0">li.innerHTML = `</span>
      <span class="s0">&lt;div&gt;</span>
        <span class="s0">&lt;strong&gt;${i.name}&lt;/strong&gt;</span>
        <span class="s0">&lt;div class=</span><span class="s1">&quot;meta&quot;</span><span class="s0">&gt;Rs. ${formatNpr(i.price)} × ${i.quantity} = Rs. ${formatNpr(i.price * i.quantity)}&lt;/div&gt;</span>
      <span class="s0">&lt;/div&gt;</span>
      <span class="s0">&lt;div class=</span><span class="s1">&quot;actions&quot;</span><span class="s0">&gt;</span>
        <span class="s0">&lt;button class=</span><span class="s1">&quot;secondary&quot; </span><span class="s0">onclick=</span><span class="s1">&quot;decQty(${i.productId})&quot;</span><span class="s0">&gt;-&lt;/button&gt;</span>
        <span class="s0">&lt;button class=</span><span class="s1">&quot;secondary&quot; </span><span class="s0">onclick=</span><span class="s1">&quot;incQty(${i.productId})&quot;</span><span class="s0">&gt;+&lt;/button&gt;</span>
        <span class="s0">&lt;button class=</span><span class="s1">&quot;danger&quot; </span><span class="s0">onclick=</span><span class="s1">&quot;removeFromCart(${i.productId})&quot;</span><span class="s0">&gt;Remove&lt;/button&gt;</span>
      <span class="s0">&lt;/div&gt;</span>
    <span class="s0">`;</span>
    <span class="s0">list.appendChild(li);</span>
  <span class="s0">});</span>

  <span class="s2">if </span><span class="s0">(cart.length &gt; </span><span class="s4">0</span><span class="s0">) {</span>
    <span class="s0">const clearBtn = document.createElement(</span><span class="s1">&quot;button&quot;</span><span class="s0">);</span>
    <span class="s0">clearBtn.className = </span><span class="s1">&quot;secondary&quot;</span><span class="s0">;</span>
    <span class="s0">clearBtn.style.marginTop = </span><span class="s1">&quot;10px&quot;</span><span class="s0">;</span>
    <span class="s0">clearBtn.textContent = </span><span class="s1">&quot;Clear Cart&quot;</span><span class="s0">;</span>
    <span class="s0">clearBtn.onclick = clearCart;</span>
    <span class="s0">list.appendChild(clearBtn);</span>
  <span class="s0">}</span>

  <span class="s3">// Recalculate totals</span>
  <span class="s0">recalcTotals();</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">money(n) {</span>
  <span class="s2">return new </span><span class="s0">Intl.NumberFormat(</span><span class="s1">&quot;en-NP&quot;</span><span class="s0">, { maximumFractionDigits: </span><span class="s4">2 </span><span class="s0">}).format(n);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">recalcTotals() {</span>
  <span class="s0">const cart = JSON.parse(localStorage.getItem(</span><span class="s1">&quot;cart&quot;</span><span class="s0">) || </span><span class="s1">&quot;[]&quot;</span><span class="s0">);</span>

  <span class="s0">let subtotal = </span><span class="s4">0</span><span class="s0">;</span>
  <span class="s0">cart.forEach(i =&gt; subtotal += (i.price * i.quantity));</span>

  <span class="s3">// apply promo discount on subtotal</span>
  <span class="s0">const discountedSubtotal = subtotal * (</span><span class="s4">1 </span><span class="s0">- promoDiscountRate);</span>

  <span class="s0">const tax = discountedSubtotal * TAX_RATE;</span>
  <span class="s0">const total = discountedSubtotal + tax;</span>

  <span class="s0">document.getElementById(</span><span class="s1">&quot;subtotal&quot;</span><span class="s0">).innerText = money(discountedSubtotal);</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;tax&quot;</span><span class="s0">).innerText = money(tax);</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;total&quot;</span><span class="s0">).innerText = money(total);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">applyPromo() {</span>
  <span class="s0">const code = (document.getElementById(</span><span class="s1">&quot;promo&quot;</span><span class="s0">).value || </span><span class="s1">&quot;&quot;</span><span class="s0">).trim().toUpperCase();</span>
  <span class="s0">const msg = document.getElementById(</span><span class="s1">&quot;promoMsg&quot;</span><span class="s0">);</span>

  <span class="s3">// Demo promo codes (you can later move to DB)</span>
  <span class="s2">if </span><span class="s0">(code === </span><span class="s1">&quot;&quot;</span><span class="s0">) {</span>
    <span class="s0">promoDiscountRate = </span><span class="s4">0</span><span class="s0">;</span>
    <span class="s0">msg.innerText = </span><span class="s1">&quot;Promo cleared.&quot;</span><span class="s0">;</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(code === </span><span class="s1">&quot;NEPAL10&quot;</span><span class="s0">) {</span>
    <span class="s0">promoDiscountRate = </span><span class="s4">0.10</span><span class="s0">;</span>
    <span class="s0">msg.innerText = </span><span class="s1">&quot;Applied NEPAL10 (10% off subtotal).&quot;</span><span class="s0">;</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(code === </span><span class="s1">&quot;FREESHIP&quot;</span><span class="s0">) {</span>
    <span class="s0">promoDiscountRate = </span><span class="s4">0.05</span><span class="s0">;</span>
    <span class="s0">msg.innerText = </span><span class="s1">&quot;Applied FREESHIP (5% off subtotal).&quot;</span><span class="s0">;</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s0">promoDiscountRate = </span><span class="s4">0</span><span class="s0">;</span>
    <span class="s0">msg.innerText = </span><span class="s1">&quot;Invalid promo code.&quot;</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s0">recalcTotals();</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">getPaymentMethod() {</span>
  <span class="s0">const r = document.querySelector(</span><span class="s1">'input[name=&quot;pay&quot;]:checked'</span><span class="s0">);</span>
  <span class="s2">return </span><span class="s0">r ? r.value : </span><span class="s1">&quot;COD&quot;</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">togglePayment() {</span>
  <span class="s0">const method = getPaymentMethod();</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;cardBox&quot;</span><span class="s0">).style.display = (method === </span><span class="s1">&quot;CARD&quot;</span><span class="s0">) ? </span><span class="s1">&quot;block&quot; </span><span class="s0">: </span><span class="s1">&quot;none&quot;</span><span class="s0">;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;cardMsg&quot;</span><span class="s0">).innerText = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">luhnCheck(num) {</span>
  <span class="s0">const s = String(num).replace(/\s+/g, </span><span class="s1">&quot;&quot;</span><span class="s0">);</span>
  <span class="s2">if </span><span class="s0">(!/^\d{</span><span class="s4">12</span><span class="s0">,</span><span class="s4">19</span><span class="s0">}$/.test(s)) </span><span class="s2">return false</span><span class="s0">;</span>
  <span class="s0">let sum = </span><span class="s4">0</span><span class="s0">, alt = </span><span class="s2">false</span><span class="s0">;</span>
  <span class="s2">for </span><span class="s0">(let i = s.length - </span><span class="s4">1</span><span class="s0">; i &gt;= </span><span class="s4">0</span><span class="s0">; i--) {</span>
    <span class="s0">let n = parseInt(s[i], </span><span class="s4">10</span><span class="s0">);</span>
    <span class="s2">if </span><span class="s0">(alt) {</span>
      <span class="s0">n *= </span><span class="s4">2</span><span class="s0">;</span>
      <span class="s2">if </span><span class="s0">(n &gt; </span><span class="s4">9</span><span class="s0">) n -= </span><span class="s4">9</span><span class="s0">;</span>
    <span class="s0">}</span>
    <span class="s0">sum += n;</span>
    <span class="s0">alt = !alt;</span>
  <span class="s0">}</span>
  <span class="s2">return </span><span class="s0">sum % </span><span class="s4">10 </span><span class="s0">=== </span><span class="s4">0</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">parseExp(mmYY) {</span>
  <span class="s0">const m = (mmYY || </span><span class="s1">&quot;&quot;</span><span class="s0">).trim();</span>
  <span class="s0">const match = m.match(/^(\d{</span><span class="s4">2</span><span class="s0">})\/(\d{</span><span class="s4">2</span><span class="s0">})$/);</span>
  <span class="s2">if </span><span class="s0">(!match) </span><span class="s2">return null</span><span class="s0">;</span>
  <span class="s0">const mm = parseInt(match[</span><span class="s4">1</span><span class="s0">], </span><span class="s4">10</span><span class="s0">);</span>
  <span class="s0">const yy = parseInt(match[</span><span class="s4">2</span><span class="s0">], </span><span class="s4">10</span><span class="s0">);</span>
  <span class="s2">if </span><span class="s0">(mm &lt; </span><span class="s4">1 </span><span class="s0">|| mm &gt; </span><span class="s4">12</span><span class="s0">) </span><span class="s2">return null</span><span class="s0">;</span>

  <span class="s3">// expiry end-of-month check (simple)</span>
  <span class="s0">const now = </span><span class="s2">new </span><span class="s0">Date();</span>
  <span class="s0">const year = </span><span class="s4">2000 </span><span class="s0">+ yy;</span>
  <span class="s0">const expDate = </span><span class="s2">new </span><span class="s0">Date(year, mm, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">23</span><span class="s0">, </span><span class="s4">59</span><span class="s0">, </span><span class="s4">59</span><span class="s0">); </span><span class="s3">// last day of month</span>
  <span class="s2">if </span><span class="s0">(expDate &lt; now) </span><span class="s2">return null</span><span class="s0">;</span>

  <span class="s2">return </span><span class="s0">{ mm, yy };</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">cardBrand(num) {</span>
  <span class="s0">const s = String(num).replace(/\s+/g, </span><span class="s1">&quot;&quot;</span><span class="s0">);</span>
  <span class="s2">if </span><span class="s0">(s.startsWith(</span><span class="s1">&quot;4&quot;</span><span class="s0">)) </span><span class="s2">return </span><span class="s1">&quot;VISA&quot;</span><span class="s0">;</span>
  <span class="s2">if </span><span class="s0">(/^</span><span class="s4">5</span><span class="s0">[</span><span class="s4">1</span><span class="s0">-</span><span class="s4">5</span><span class="s0">]/.test(s)) </span><span class="s2">return </span><span class="s1">&quot;MASTERCARD&quot;</span><span class="s0">;</span>
  <span class="s2">if </span><span class="s0">(/^</span><span class="s4">3</span><span class="s0">[</span><span class="s4">47</span><span class="s0">]/.test(s)) </span><span class="s2">return </span><span class="s1">&quot;AMEX&quot;</span><span class="s0">;</span>
  <span class="s2">return </span><span class="s1">&quot;CARD&quot;</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">validateCard() {</span>
  <span class="s0">const number = document.getElementById(</span><span class="s1">&quot;cardNumber&quot;</span><span class="s0">).value;</span>
  <span class="s0">const exp = document.getElementById(</span><span class="s1">&quot;cardExp&quot;</span><span class="s0">).value;</span>
  <span class="s0">const cvv = document.getElementById(</span><span class="s1">&quot;cardCvv&quot;</span><span class="s0">).value;</span>
  <span class="s0">const msg = document.getElementById(</span><span class="s1">&quot;cardMsg&quot;</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(!luhnCheck(number)) </span><span class="s2">return </span><span class="s0">msg.innerText = </span><span class="s1">&quot;Invalid card number.&quot;</span><span class="s0">;</span>
  <span class="s2">if </span><span class="s0">(!parseExp(exp)) </span><span class="s2">return </span><span class="s0">msg.innerText = </span><span class="s1">&quot;Invalid expiry (MM/YY) or card expired.&quot;</span><span class="s0">;</span>
  <span class="s2">if </span><span class="s0">(!/^\d{</span><span class="s4">3</span><span class="s0">,</span><span class="s4">4</span><span class="s0">}$/.test((cvv || </span><span class="s1">&quot;&quot;</span><span class="s0">).trim())) </span><span class="s2">return </span><span class="s0">msg.innerText = </span><span class="s1">&quot;Invalid CVV.&quot;</span><span class="s0">;</span>

  <span class="s0">msg.innerText = `Card looks valid (${cardBrand(number)} •••• ${String(number).replace(/\s+/g,</span><span class="s1">&quot;&quot;</span><span class="s0">).slice(-</span><span class="s4">4</span><span class="s0">)}).`;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">getCartStoreId() {</span>
  <span class="s0">const first = cart.find(i =&gt; i.storeId != </span><span class="s2">null</span><span class="s0">);</span>
  <span class="s2">return </span><span class="s0">first ? first.storeId : </span><span class="s2">null</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s0">async </span><span class="s2">function </span><span class="s0">placeOrder() {</span>
  <span class="s0">const address = document.getElementById(</span><span class="s1">&quot;address&quot;</span><span class="s0">).value.trim();</span>
  <span class="s2">if </span><span class="s0">(!address) </span><span class="s2">return </span><span class="s0">alert(</span><span class="s1">&quot;Delivery address required&quot;</span><span class="s0">);</span>
  <span class="s2">if </span><span class="s0">(cart.length === </span><span class="s4">0</span><span class="s0">) </span><span class="s2">return </span><span class="s0">alert(</span><span class="s1">&quot;Cart is empty&quot;</span><span class="s0">);</span>

  <span class="s0">const promoCode = (document.getElementById(</span><span class="s1">&quot;promo&quot;</span><span class="s0">).value || </span><span class="s1">&quot;&quot;</span><span class="s0">).trim().toUpperCase();</span>
  <span class="s0">const paymentMethod = getPaymentMethod();</span>

  <span class="s0">let card = </span><span class="s2">null</span><span class="s0">;</span>
  <span class="s2">if </span><span class="s0">(paymentMethod === </span><span class="s1">&quot;CARD&quot;</span><span class="s0">) {</span>
    <span class="s0">const number = document.getElementById(</span><span class="s1">&quot;cardNumber&quot;</span><span class="s0">).value;</span>
    <span class="s0">const exp = document.getElementById(</span><span class="s1">&quot;cardExp&quot;</span><span class="s0">).value;</span>

    <span class="s2">if </span><span class="s0">(!luhnCheck(number) || !parseExp(exp)) {</span>
      <span class="s0">alert(</span><span class="s1">&quot;Please enter valid card details.&quot;</span><span class="s0">);</span>
      <span class="s2">return</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s0">const clean = String(number).replace(/\s+/g, </span><span class="s1">&quot;&quot;</span><span class="s0">);</span>
    <span class="s0">card = {</span>
      <span class="s0">brand: cardBrand(clean),</span>
      <span class="s0">last4: clean.slice(-</span><span class="s4">4</span><span class="s0">),</span>
      <span class="s0">expiry: exp.trim()</span>
      <span class="s3">// DO NOT send/store CVV in backend</span>
    <span class="s0">};</span>
  <span class="s0">}</span>

  <span class="s0">const payload = {</span>
    <span class="s0">userId: user.id,</span>
    <span class="s0">deliveryAddress: address,</span>
    <span class="s0">items: cart.map(i =&gt; ({ productId: i.productId, quantity: i.quantity })),</span>
    <span class="s0">promoCode: promoCode || </span><span class="s2">null</span><span class="s0">,</span>
    <span class="s0">paymentMethod: paymentMethod,</span>
    <span class="s0">card: card</span>
  <span class="s0">};</span>

  <span class="s0">const res = await fetch(</span><span class="s1">&quot;/api/orders&quot;</span><span class="s0">, {</span>
    <span class="s0">method: </span><span class="s1">&quot;POST&quot;</span><span class="s0">,</span>
    <span class="s0">headers: { </span><span class="s1">&quot;Content-Type&quot;</span><span class="s0">: </span><span class="s1">&quot;application/json&quot; </span><span class="s0">},</span>
    <span class="s0">body: JSON.stringify(payload)</span>
  <span class="s0">});</span>

  <span class="s2">if </span><span class="s0">(!res.ok) {</span>
    <span class="s0">alert(</span><span class="s1">&quot;Order failed (check stock / server).&quot;</span><span class="s0">);</span>
    <span class="s2">return</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s0">alert(</span><span class="s1">&quot;Order placed successfully!&quot;</span><span class="s0">);</span>
  <span class="s0">clearCart();</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;address&quot;</span><span class="s0">).value = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;promo&quot;</span><span class="s0">).value = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>
  <span class="s0">promoDiscountRate = </span><span class="s4">0</span><span class="s0">;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;promoMsg&quot;</span><span class="s0">).innerText = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>

  <span class="s3">// Reset payment method to COD</span>
  <span class="s0">document.querySelector(</span><span class="s1">'input[name=&quot;pay&quot;][value=&quot;COD&quot;]'</span><span class="s0">).checked = </span><span class="s2">true</span><span class="s0">;</span>
  <span class="s0">togglePayment();</span>

  <span class="s3">// Clear card fields</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;cardName&quot;</span><span class="s0">).value = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;cardNumber&quot;</span><span class="s0">).value = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;cardExp&quot;</span><span class="s0">).value = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;cardCvv&quot;</span><span class="s0">).value = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>
  <span class="s0">document.getElementById(</span><span class="s1">&quot;cardMsg&quot;</span><span class="s0">).innerText = </span><span class="s1">&quot;&quot;</span><span class="s0">;</span>

  <span class="s0">await loadProducts();</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">logout() {</span>
  <span class="s0">localStorage.removeItem(</span><span class="s1">&quot;user&quot;</span><span class="s0">);</span>
  <span class="s0">localStorage.removeItem(</span><span class="s1">&quot;cart&quot;</span><span class="s0">);</span>
  <span class="s0">window.location.href = </span><span class="s1">&quot;/login.html&quot;</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">formatNpr(n) {</span>
  <span class="s2">return new </span><span class="s0">Intl.NumberFormat(</span><span class="s1">&quot;en-NP&quot;</span><span class="s0">, { maximumFractionDigits: </span><span class="s4">2 </span><span class="s0">}).format(n);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">escapeQuotes(s) {</span>
  <span class="s2">return </span><span class="s0">(s || </span><span class="s1">&quot;&quot;</span><span class="s0">).replace(/</span><span class="s1">'/g, &quot;</span><span class="s2">\\</span><span class="s1">'&quot;);</span>
<span class="s0">}</span></pre>
</body>
</html>